# è®­ç»ƒæ—¶OOMé—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸš¨ é—®é¢˜è¯´æ˜

è®­ç»ƒæ—¶å‡ºç°**Out of Memory (OOM)**ï¼Œå³ä½¿ä½¿ç”¨äº†batch chunkingä»ç„¶å†…å­˜ä¸è¶³ã€‚

**åŸå› ï¼š** è®­ç»ƒå’Œæ¨ç†çš„å†…å­˜éœ€æ±‚å·®å¼‚å·¨å¤§
- **æ¨ç†**ï¼šåªéœ€è¦å‰å‘ä¼ æ’­ï¼Œä¸ä¿å­˜ä¸­é—´æ¿€æ´»
- **è®­ç»ƒ**ï¼šéœ€è¦ä¿å­˜æ‰€æœ‰ä¸­é—´æ¿€æ´»ç”¨äºåå‘ä¼ æ’­ï¼Œå†…å­˜å ç”¨æ˜¯æ¨ç†çš„**2-3å€**

## âœ… è§£å†³æ–¹æ¡ˆï¼ˆæŒ‰æ¨èé¡ºåºï¼‰

### æ–¹æ¡ˆ1ï¼šæ¢¯åº¦ç´¯ç§¯ â­ æœ€æ¨è

é€šè¿‡ç´¯ç§¯å¤šä¸ªå°batchçš„æ¢¯åº¦æ¥æ¨¡æ‹Ÿå¤§batchè®­ç»ƒã€‚

**é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼š**
```yaml
# configs/config.yaml
train:
  accumulate_grad_batches: 4  # ç´¯ç§¯4ä¸ªbatchçš„æ¢¯åº¦
  
data:
  batch_size: 1  # å‡å°å®é™…batch size
  video_batch_size: 1  # è§†é¢‘å¤„ç†batch sizeä¹Ÿè¦å°
```

**æ•ˆæœï¼š**
- å®é™…batch size = 1ï¼Œä½†ç­‰æ•ˆè®­ç»ƒbatch size = 1 Ã— 4 = 4
- å†…å­˜éœ€æ±‚ï¼š â†“â†“â†“ é™ä½75%
- è®­ç»ƒæ•ˆæœï¼š âœ… ä¸å¤§batchåŸºæœ¬ç›¸åŒ

**è®­ç»ƒå‘½ä»¤ï¼š**
```bash
python project/main.py \
    --config configs/config.yaml \
    --trainer.accumulate_grad_batches=4
```

---

### æ–¹æ¡ˆ2ï¼šæ··åˆç²¾åº¦è®­ç»ƒ â­â­ å¼ºçƒˆæ¨è

ä½¿ç”¨FP16ï¼ˆåŠç²¾åº¦ï¼‰ä»£æ›¿FP32ï¼ˆå…¨ç²¾åº¦ï¼‰ã€‚

**é…ç½®ä¿®æ”¹ï¼š**
```yaml
# configs/config.yaml
trainer:
  precision: 16  # æˆ–è€… 'bf16'ï¼ˆå¦‚æœGPUæ”¯æŒï¼‰
  amp_backend: 'native'
```

**æˆ–å‘½ä»¤è¡Œï¼š**
```bash
python project/main.py \
    --config configs/config.yaml \
    --trainer.precision=16
```

**æ•ˆæœï¼š**
- å†…å­˜éœ€æ±‚ï¼š â†“â†“ é™ä½çº¦50%
- é€Ÿåº¦ï¼š â†‘â†‘ æå‡30-50%
- ç²¾åº¦ï¼š âœ… é€šå¸¸æ— æ˜æ˜¾æŸå¤±

**æ³¨æ„ï¼š** éœ€è¦æ”¯æŒFP16çš„GPUï¼ˆå¦‚V100, A100, RTXç³»åˆ—ï¼‰

---

### æ–¹æ¡ˆ3ï¼šæ¢¯åº¦ç´¯ç§¯ + æ··åˆç²¾åº¦ â­â­â­ æœ€ä½³ç»„åˆ

ç»“åˆæ–¹æ¡ˆ1å’Œæ–¹æ¡ˆ2ï¼Œæ•ˆæœæœ€å¥½ã€‚

**é…ç½®ï¼š**
```yaml
train:
  accumulate_grad_batches: 8
  
data:
  batch_size: 1
  video_batch_size: 1
  
trainer:
  precision: 16
```

**æ•ˆæœï¼š**
- å†…å­˜éœ€æ±‚ï¼š â†“â†“â†“ é™ä½çº¦85%
- ç­‰æ•ˆbatch size = 8
- è®­ç»ƒé€Ÿåº¦å¿«ï¼Œå†…å­˜å ç”¨ä½

---

### æ–¹æ¡ˆ4ï¼šå‡å°‘è§†é¢‘åˆ†è¾¨ç‡/å¸§æ•°

å‡å°è¾“å…¥æ•°æ®çš„å¤§å°ã€‚

**é…ç½®ä¿®æ”¹ï¼š**
```yaml
data:
  img_size: [112, 112]  # ä»224é™åˆ°112
  num_frames: 8         # ä»16é™åˆ°8
  temporal_stride: 2    # æ¯éš”1å¸§é‡‡æ ·1å¸§
```

**æ•ˆæœï¼š**
- åˆ†è¾¨ç‡å‡åŠ â†’ å†…å­˜é™ä½çº¦75%
- å¸§æ•°å‡åŠ â†’ å†…å­˜é™ä½çº¦50%
- âš ï¸ å¯èƒ½å½±å“æ¨¡å‹æ€§èƒ½

---

### æ–¹æ¡ˆ5ï¼šæ¢¯åº¦æ£€æŸ¥ç‚¹ï¼ˆGradient Checkpointingï¼‰

ä¸ä¿å­˜æ‰€æœ‰ä¸­é—´æ¿€æ´»ï¼Œåå‘ä¼ æ’­æ—¶é‡æ–°è®¡ç®—ã€‚

**æ¨¡å‹ä¿®æ”¹ï¼ˆéœ€è¦åœ¨æ¨¡å‹ä»£ç ä¸­æ·»åŠ ï¼‰ï¼š**
```python
import torch.utils.checkpoint as checkpoint

# åœ¨forwardä¸­ä½¿ç”¨
def forward(self, x):
    # ä½¿ç”¨checkpointingåŒ…è£…è®¡ç®—å¯†é›†çš„å±‚
    x = checkpoint.checkpoint(self.backbone_layer, x)
    return x
```

**æ•ˆæœï¼š**
- å†…å­˜éœ€æ±‚ï¼š â†“â†“â†“ å¤§å¹…é™ä½
- è®­ç»ƒé€Ÿåº¦ï¼š â†“ æ…¢10-30%ï¼ˆéœ€è¦é‡æ–°è®¡ç®—ï¼‰
- é€‚åˆè¶…é•¿è§†é¢‘æˆ–è¶…æ·±æ¨¡å‹

---

### æ–¹æ¡ˆ6ï¼šè°ƒæ•´DataLoaderè®¾ç½®

**é…ç½®ï¼š**
```yaml
data:
  batch_size: 1
  num_workers: 2        # å‡å°‘workeræ•°é‡
  pin_memory: false     # ç¦ç”¨pin memory
  prefetch_factor: 1    # å‡å°‘é¢„å–
  persistent_workers: false
```

**é…ç½®åªåŠ è½½å¿…è¦æ•°æ®ï¼š**
```yaml
data:
  load_rgb: true        # åªåŠ è½½RGB
  load_kpt: false       # ä¸åŠ è½½å…³é”®ç‚¹ï¼ˆèŠ‚çœå†…å­˜ï¼‰
```

---

## ğŸ“Š å†…å­˜å ç”¨ä¼°ç®—

ä»¥ä¸‹æ˜¯ä¸åŒé…ç½®çš„å†…å­˜ä½¿ç”¨ä¼°ç®—ï¼ˆå•ä¸ªæ ·æœ¬ï¼‰ï¼š

| é…ç½® | åˆ†è¾¨ç‡ | å¸§æ•° | ç²¾åº¦ | é¢„ä¼°æ˜¾å­˜ |
|------|--------|------|------|----------|
| åŸºçº¿ | 224Ã—224 | 16 | FP32 | ~8GB |
| + æ··åˆç²¾åº¦ | 224Ã—224 | 16 | FP16 | ~4GB |
| + é™ä½åˆ†è¾¨ç‡ | 112Ã—112 | 16 | FP16 | ~1GB |
| + å‡å°‘å¸§æ•° | 112Ã—112 | 8 | FP16 | ~0.5GB |

**æ¢¯åº¦ç´¯ç§¯ä¸å‡å°‘å•ä¸ªbatchçš„å†…å­˜å ç”¨ï¼Œä½†å…è®¸ä½¿ç”¨æ›´å°çš„batch sizeã€‚**

---

## ğŸ¯ æ¨èé…ç½®æ–¹æ¡ˆ

### å¯¹äº12GBæ˜¾å­˜ï¼ˆå¦‚RTX 3080Ti, RTX 4070Tiï¼‰

```yaml
train:
  accumulate_grad_batches: 4
  
data:
  batch_size: 1
  video_batch_size: 1
  img_size: [224, 224]
  num_frames: 8
  load_rgb: true
  load_kpt: false
  
trainer:
  precision: 16
  max_epochs: 50
```

### å¯¹äº8GBæ˜¾å­˜ï¼ˆå¦‚RTX 3070ï¼‰

```yaml
train:
  accumulate_grad_batches: 8
  
data:
  batch_size: 1
  video_batch_size: 1
  img_size: [112, 112]  # é™ä½åˆ†è¾¨ç‡
  num_frames: 8
  load_rgb: true
  load_kpt: false
  
trainer:
  precision: 16
```

### å¯¹äº24GB+æ˜¾å­˜ï¼ˆå¦‚RTX 3090, A100ï¼‰

```yaml
train:
  accumulate_grad_batches: 2
  
data:
  batch_size: 2
  video_batch_size: 2
  img_size: [224, 224]
  num_frames: 16
  
trainer:
  precision: 16  # ä»ç„¶æ¨èï¼Œæé€Ÿæ˜æ˜¾
```

---

## ğŸ”§ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šéªŒè¯å½“å‰å†…å­˜ä½¿ç”¨

```bash
# è¿è¡Œè®­ç»ƒå¹¶ç›‘æ§GPU
nvidia-smi -l 1  # å¦ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­è¿è¡Œ
```

### ç¬¬äºŒæ­¥ï¼šåº”ç”¨æ¢¯åº¦ç´¯ç§¯ + æ··åˆç²¾åº¦

**ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š**
```yaml
# configs/config.yaml
train:
  accumulate_grad_batches: 4
  
trainer:
  precision: 16
  
data:
  batch_size: 1
```

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•è¿è¡Œ

```bash
python project/main.py \
    --config configs/config.yaml \
    --trainer.limit_train_batches=10
```

### ç¬¬å››æ­¥ï¼šæ ¹æ®ç»“æœè°ƒæ•´

- å¦‚æœ**ä»ç„¶OOM** â†’ å¢åŠ `accumulate_grad_batches`æˆ–é™ä½åˆ†è¾¨ç‡
- å¦‚æœ**å†…å­˜å……è¶³** â†’ å¯ä»¥å¢å¤§batch_sizeæˆ–åˆ†è¾¨ç‡
- ç›‘æ§è®­ç»ƒæŒ‡æ ‡ç¡®ä¿æ€§èƒ½æ²¡æœ‰ä¸‹é™

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ï¼šå¯ç”¨FP16åè®­ç»ƒä¸ç¨³å®š

**è§£å†³ï¼š**
```yaml
trainer:
  precision: 'bf16'  # ä½¿ç”¨bfloat16ï¼ˆå¦‚æœGPUæ”¯æŒï¼‰
```

æˆ–ä¿æŒFP32ä½†ä½¿ç”¨æ›´å¤šæ¢¯åº¦ç´¯ç§¯ï¼š
```yaml
trainer:
  precision: 32
  
train:
  accumulate_grad_batches: 8  # å¢åŠ ç´¯ç§¯æ­¥æ•°
```

### é—®é¢˜ï¼šæ¢¯åº¦ç´¯ç§¯åæ”¶æ•›å˜æ…¢

**è§£å†³ï¼š** è°ƒæ•´å­¦ä¹ ç‡
```yaml
loss:
  lr: 0.001  # å¦‚æœaccumulate=4, å¯ä»¥å°è¯• lr * 4 = 0.004
```

### é—®é¢˜ï¼šDataLoaderä¹Ÿå ç”¨å¤§é‡å†…å­˜

**è§£å†³ï¼š**
```yaml
data:
  num_workers: 0  # ç¦ç”¨å¤šè¿›ç¨‹
  prefetch_factor: null
  persistent_workers: false
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | æ˜¾å­˜å ç”¨ | è®­ç»ƒé€Ÿåº¦ | æ¨¡å‹æ€§èƒ½ |
|------|---------|---------|---------|
| åŸºçº¿ï¼ˆbatch=4, FP32ï¼‰ | 100% | 100% | 100% |
| + FP16 | 50% | 130-150% | ~100% |
| + æ¢¯åº¦ç´¯ç§¯(4) | 25% | 90% | ~100% |
| + FP16 + æ¢¯åº¦ç´¯ç§¯(4) | 12.5% | 120% | ~100% |
| + é™ä½åˆ†è¾¨ç‡(112) | 6% | 200% | 90-95% |

---

## âœ… æ£€æŸ¥æ¸…å•

è®­ç»ƒå‰ç¡®è®¤ï¼š

- [ ] è®¾ç½®äº†`accumulate_grad_batches`
- [ ] å¯ç”¨äº†æ··åˆç²¾åº¦è®­ç»ƒï¼ˆ`precision=16`ï¼‰
- [ ] å‡å°äº†batch_sizeï¼ˆé€šå¸¸è®¾ä¸º1ï¼‰
- [ ] åªåŠ è½½å¿…è¦çš„æ¨¡æ€æ•°æ®ï¼ˆ`load_kpt=false`ï¼‰
- [ ] è°ƒæ•´äº†è§†é¢‘åˆ†è¾¨ç‡ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
- [ ] ç›‘æ§GPUå†…å­˜ä½¿ç”¨ï¼ˆ`nvidia-smi`ï¼‰
- [ ] éªŒè¯è®­ç»ƒæŒ‡æ ‡æ­£å¸¸

---

## ğŸ“ ç†è§£ä¸ºä»€ä¹ˆè®­ç»ƒæ—¶chunkingä¸èµ·ä½œç”¨

**è®­ç»ƒ vs æ¨ç†çš„å†…å­˜ä½¿ç”¨ï¼š**

```
æ¨ç†ï¼ˆInferenceï¼‰:
Input â†’ Forward Pass â†’ Output
       â†‘ åªéœ€è¦ä¸­é—´æ¿€æ´»

è®­ç»ƒï¼ˆTrainingï¼‰:
Input â†’ Forward Pass â†’ Output â†’ Loss
       â†“ ä¿å­˜æ‰€æœ‰æ¿€æ´»
       Backward Pass â† Gradients
       â†“ éœ€è¦å¤§é‡å†…å­˜
       Update Weights
```

**Chunkingçš„é—®é¢˜ï¼š**
- Chunkingåˆ†å‰²batchï¼Œä½†æ¯ä¸ªchunkä»éœ€è¦å®Œæ•´çš„å‰å‘+åå‘ä¼ æ’­
- æ‰€æœ‰chunkçš„æ¢¯åº¦éœ€è¦ç´¯ç§¯ï¼Œå†…å­˜èŠ‚çœæœ‰é™
- æ›´å¥½çš„æ–¹æ³•æ˜¯**æ¢¯åº¦ç´¯ç§¯**ï¼Œå®ƒåœ¨chunké—´å…±äº«å†…å­˜

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ¡ˆéƒ½æ— æ³•è§£å†³ï¼š

1. æ£€æŸ¥æ¨¡å‹æ¶æ„æ˜¯å¦è¿‡å¤§
2. è€ƒè™‘ä½¿ç”¨æ›´å°çš„æ¨¡å‹ï¼ˆå¦‚ResNet18 vs ResNet50ï¼‰
3. ä½¿ç”¨åˆ†å¸ƒå¼è®­ç»ƒï¼ˆå¤šGPUï¼‰
4. è”ç³»å¼€å‘è€…è·å–æ”¯æŒ

---

**æœ€åæ›´æ–°**: 2026-02-08  
**ç‰ˆæœ¬**: 1.0
